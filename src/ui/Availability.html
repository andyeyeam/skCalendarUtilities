<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Availability</title>
    <?!= include('ui/Styles'); ?>
    <style>
      /* Slot selection styles */
      .slot-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
      }

      .slot-item:last-child {
        border-bottom: none;
      }

      .slot-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        gap: 0.75rem;
      }

      .slot-checkbox {
        margin: 0;
        cursor: pointer;
        flex-shrink: 0;
        width: 18px;
        height: 18px;
      }

      .slot-time {
        font-weight: 600;
        flex-grow: 1;
      }

      .slot-duration {
        color: #666;
        font-size: 0.875rem;
      }

      .slot-item.selected {
        background-color: #f5f5f5;
      }

      .slot-label:hover {
        background-color: #fafafa;
      }

      /* Button secondary style */
      .button-secondary {
        background-color: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.875rem;
        font-weight: 500;
        transition: background-color 0.2s;
      }

      .button-secondary:hover {
        background-color: #e8e8e8;
      }

      .button-secondary:active {
        background-color: #ddd;
      }

      /* Section headers for Available/Scheduled */
      .section-header {
        font-weight: 600;
        font-size: 0.875rem;
        color: #666;
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Event items */
      .event-item {
        background-color: #fafafa;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.25rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .event-item:last-child {
        border-bottom: none;
      }

      .event-time {
        font-size: 0.875rem;
        color: #666;
        font-weight: 400;
      }

      .event-title {
        font-size: 1rem;
        color: #333;
        font-weight: 500;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Back button -->
      <button class="back-button" onclick="navigateToMenu()">
        ‚Üê Back to Menu
      </button>

      <h1>Find Availability</h1>

      <!-- Calendar info -->
      <div id="calendarInfo" class="card mb-3">
        <p class="text-muted mb-0" style="font-size: 0.875rem;">
          Searching calendar: <span id="calendarName">Loading...</span>
        </p>
      </div>

      <!-- Search form -->
      <div class="card mb-3">
        <form id="searchForm" onsubmit="handleFindAvailability(event); return false;">
          <!-- Search Mode Selection -->
          <div class="form-group">
            <label>Search Mode:</label>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="searchMode" value="duration" checked onchange="handleModeChange()">
                <span><strong>Duration-based slots</strong> - Find slots of specific duration</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="searchMode" value="contiguous" onchange="handleModeChange()">
                <span><strong>Contiguous blocks</strong> - Show all uninterrupted free time</span>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label for="startDateTime">From Date+Time: <span id="startDayOfWeek" style="color: #666; font-weight: normal;"></span></label>
            <input type="datetime-local" id="startDateTime" required>
          </div>

          <div class="form-group">
            <label for="endDateTime">To Date+Time: <span id="endDayOfWeek" style="color: #666; font-weight: normal;"></span></label>
            <input type="datetime-local" id="endDateTime" required>
          </div>

          <div class="form-group">
            <label for="minDuration">Minimum Duration (minutes):</label>
            <input type="number" id="minDuration" min="15" max="120" value="30" required>
            <p class="text-muted mb-0" style="font-size: 0.75rem; margin-top: 0.25rem;">
              Enter duration between 15 and 120 minutes
            </p>
          </div>

          <button type="submit" class="button">Find Availability</button>
        </form>
      </div>

      <!-- Loading indicator -->
      <div id="loadingIndicator" class="loading hidden">
        <div class="spinner"></div>
        <p>Searching calendar...</p>
      </div>

      <!-- Results section -->
      <div id="resultsSection" class="hidden">
        <div id="resultsMetadata" class="card mb-3"></div>

        <!-- Selection controls -->
        <div id="selectionControls" class="card mb-2">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <button id="toggleSelectAll" class="button-secondary" onclick="handleToggleSelectAll()">Select All</button>
            <span id="selectedCount" class="text-muted" style="font-size: 0.875rem;">0 selected</span>
          </div>
          <div>
            <button id="copySelected" class="button" onclick="handleCopySelected()" disabled>Copy Selected</button>
          </div>
        </div>

        <div id="resultsSlots"></div>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="card hidden">
        <div class="empty-state">
          <h3>No Availability Found</h3>
          <p>There are no available time slots matching your search criteria.</p>
          <p class="text-muted">Try expanding your date range or check if all time slots are booked.</p>
        </div>
      </div>

    </div>

    <!-- Status message (fixed position toast) -->
    <div id="errorMessage" class="message hidden" style="position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 1000; min-width: 300px; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>

    <script>
      // ============================================================================
      // SELECTION STATE MANAGEMENT
      // ============================================================================

      var SelectionManager = {
        STORAGE_KEY: 'availability_selectedSlots',

        /**
         * Load selection state from session storage
         * @returns {Object} Selection state object
         */
        load: function() {
          try {
            var stored = sessionStorage.getItem(this.STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
          } catch (e) {
            console.error('Failed to load selection state:', e);
            return {};
          }
        },

        /**
         * Save selection state to session storage
         * @param {Object} state - Selection state object
         */
        save: function(state) {
          try {
            sessionStorage.setItem(this.STORAGE_KEY, JSON.stringify(state));
          } catch (e) {
            console.error('Failed to save selection state:', e);
          }
        },

        /**
         * Toggle slot selection
         * @param {string} slotId - Unique slot identifier
         * @returns {boolean} New selection state
         */
        toggle: function(slotId) {
          var state = this.load();
          state[slotId] = !state[slotId];
          if (!state[slotId]) {
            delete state[slotId]; // Remove false values to save space
          }
          this.save(state);
          return !!state[slotId];
        },

        /**
         * Check if slot is selected
         * @param {string} slotId - Unique slot identifier
         * @returns {boolean} True if selected
         */
        isSelected: function(slotId) {
          var state = this.load();
          return !!state[slotId];
        },

        /**
         * Select all slots
         * @param {Array<string>} slotIds - All slot identifiers
         */
        selectAll: function(slotIds) {
          var state = {};
          slotIds.forEach(function(id) {
            state[id] = true;
          });
          this.save(state);
        },

        /**
         * Deselect all slots
         */
        deselectAll: function() {
          this.save({});
        },

        /**
         * Get all selected slot IDs
         * @returns {Array<string>} Array of selected slot IDs
         */
        getSelected: function() {
          var state = this.load();
          return Object.keys(state).filter(function(key) {
            return state[key];
          });
        },

        /**
         * Clear selection state (on navigation away, etc.)
         */
        clear: function() {
          sessionStorage.removeItem(this.STORAGE_KEY);
        }
      };

      // ============================================================================
      // SLOT ID GENERATION
      // ============================================================================

      /**
       * Generate unique identifier for a slot
       * @param {Object} slot - Slot object with date and formattedStart
       * @returns {string} Unique identifier (format: "YYYY-MM-DD_HH:MM AM/PM")
       */
      function getSlotId(slot) {
        return slot.date + '_' + slot.formattedStart;
      }

      /**
       * Get slot data objects by IDs
       * @param {Array<string>} slotIds - Array of slot identifiers
       * @returns {Array<Object>} Array of slot objects
       */
      function getSlotDataByIds(slotIds) {
        return allAvailableSlots.filter(function(slot) {
          var slotId = getSlotId(slot);
          return slotIds.indexOf(slotId) !== -1;
        });
      }

      // ============================================================================
      // EVENT HANDLERS
      // ============================================================================

      /**
       * Handle individual slot checkbox toggle
       * @param {HTMLInputElement} checkbox - The checkbox element
       */
      function handleSlotToggle(checkbox) {
        var slotId = checkbox.dataset.slotId;
        SelectionManager.toggle(slotId);

        // Update visual state
        var slotItem = checkbox.closest('.slot-item');
        if (checkbox.checked) {
          slotItem.classList.add('selected');
        } else {
          slotItem.classList.remove('selected');
        }

        updateSelectedCount();
        updateCopyButton();
      }

      /**
       * Handle select all / deselect all button click
       */
      function handleToggleSelectAll() {
        var allCheckboxes = document.querySelectorAll('.slot-checkbox');
        var allSlotIds = Array.from(allCheckboxes).map(function(cb) {
          return cb.dataset.slotId;
        });

        var selectedCount = SelectionManager.getSelected().length;
        var allSelected = allSlotIds.length > 0 && selectedCount === allSlotIds.length;

        if (allSelected) {
          SelectionManager.deselectAll();
        } else {
          SelectionManager.selectAll(allSlotIds);
        }

        // Update all checkboxes and visual states
        allCheckboxes.forEach(function(checkbox) {
          var slotId = checkbox.dataset.slotId;
          var isSelected = SelectionManager.isSelected(slotId);
          checkbox.checked = isSelected;

          var slotItem = checkbox.closest('.slot-item');
          if (isSelected) {
            slotItem.classList.add('selected');
          } else {
            slotItem.classList.remove('selected');
          }
        });

        updateSelectedCount();
        updateCopyButton();
      }

      /**
       * Handle copy selected slots button click
       */
      function handleCopySelected() {
        var selectedIds = SelectionManager.getSelected();

        if (selectedIds.length === 0) {
          showMessage('Please select at least one slot to copy', 'error');
          return;
        }

        // Get slot data for selected IDs
        var selectedSlots = getSlotDataByIds(selectedIds);

        // Format for clipboard
        var formattedText = formatSlotsForClipboard(selectedSlots);

        // Copy to clipboard with fallback
        copyToClipboard(
          formattedText,
          function() {
            showMessage('Copied ' + selectedIds.length + ' slot(s) to clipboard', 'success');
          },
          function(text) {
            showFallbackModal(text);
          }
        );
      }

      // ============================================================================
      // UI UPDATE HELPERS
      // ============================================================================

      /**
       * Update selected count display and toggle button text
       */
      function updateSelectedCount() {
        var selected = SelectionManager.getSelected();
        var count = selected.length;
        var countSpan = document.getElementById('selectedCount');
        var toggleBtn = document.getElementById('toggleSelectAll');

        if (countSpan) {
          countSpan.textContent = count + ' selected';
        }

        if (toggleBtn) {
          var allSlots = document.querySelectorAll('.slot-checkbox');
          var allSelected = allSlots.length > 0 && count === allSlots.length;
          toggleBtn.textContent = allSelected ? 'Deselect All' : 'Select All';
        }
      }

      /**
       * Update copy button enabled/disabled state
       */
      function updateCopyButton() {
        var selected = SelectionManager.getSelected();
        var copyBtn = document.getElementById('copySelected');
        if (copyBtn) {
          copyBtn.disabled = selected.length === 0;
        }
      }

      // ============================================================================
      // CLIPBOARD OPERATIONS
      // ============================================================================

      /**
       * Copy text to clipboard with automatic fallback for errors
       * @param {string} text - The text to copy
       * @param {function} onSuccess - Success callback
       * @param {function} onError - Error callback with fallback
       */
      function copyToClipboard(text, onSuccess, onError) {
        // Check if Clipboard API is available
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text)
            .then(function() {
              console.log('Clipboard copy successful');
              if (onSuccess) onSuccess();
            })
            .catch(function(err) {
              console.error('Clipboard API failed:', err);
              if (onError) onError(text);
            });
        } else {
          // Clipboard API not available - trigger fallback immediately
          console.warn('Clipboard API not available');
          if (onError) onError(text);
        }
      }

      /**
       * Format selected slots for clipboard
       * @param {Array<Object>} slots - Array of selected slot objects
       * @returns {string} Formatted plain text
       */
      function formatSlotsForClipboard(slots) {
        if (slots.length === 0) return '';

        // Group slots by date
        var grouped = {};
        slots.forEach(function(slot) {
          if (!grouped[slot.date]) {
            grouped[slot.date] = [];
          }
          grouped[slot.date].push(slot);
        });

        // Sort dates chronologically
        var sortedDates = Object.keys(grouped).sort();

        // Format each date block
        var blocks = sortedDates.map(function(dateStr) {
          var dateSlots = grouped[dateStr];

          // Sort slots by start time
          dateSlots.sort(function(a, b) {
            return a.formattedStart.localeCompare(b.formattedStart);
          });

          // Format date header (e.g., "Monday, Jan 15")
          var dateObj = new Date(dateStr);
          var dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'long' });
          var month = dateObj.toLocaleDateString('en-US', { month: 'short' });
          var day = dateObj.getDate();
          var dateHeader = dayOfWeek + ', ' + month + ' ' + day;

          // Format time slots on separate lines (e.g., "9:00 AM - 10:00 AM (60 min)")
          var timeSlots = dateSlots.map(function(slot) {
            return slot.formattedStart + ' - ' + slot.formattedEnd + ' (' + slot.formattedDuration + ')';
          }).join('\n');

          // Return date header followed by time slots
          return dateHeader + '\n' + timeSlots;
        });

        // Join date blocks with double newlines
        return blocks.join('\n\n');
      }

      /**
       * Show fallback modal for manual copy
       * @param {string} text - The text to display for copying
       */
      function showFallbackModal(text) {
        // Remove existing modal if present
        var existing = document.getElementById('clipboardFallbackModal');
        if (existing) {
          document.body.removeChild(existing);
        }

        // Create modal overlay
        var modal = document.createElement('div');
        modal.id = 'clipboardFallbackModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; ' +
          'background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; ' +
          'z-index: 1000;';

        // Create modal content
        var content = document.createElement('div');
        content.className = 'card';
        content.style.cssText = 'max-width: 500px; width: 90%;';

        // Title
        var title = document.createElement('h3');
        title.textContent = 'Copy to Clipboard';
        title.style.marginTop = '0';
        content.appendChild(title);

        // Instructions
        var instructions = document.createElement('p');
        instructions.textContent = 'Please select the text below and copy it manually (Ctrl+C or Cmd+C):';
        instructions.className = 'text-muted';
        content.appendChild(instructions);

        // Textarea with text
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.readOnly = true;
        textarea.style.cssText = 'width: 100%; height: 150px; font-family: inherit; ' +
          'font-size: 0.875rem; padding: 0.5rem; border: 1px solid #ccc; ' +
          'border-radius: 4px; resize: vertical;';
        content.appendChild(textarea);

        // Close button
        var closeBtn = document.createElement('button');
        closeBtn.textContent = 'Close';
        closeBtn.className = 'button';
        closeBtn.style.marginTop = '1rem';
        closeBtn.onclick = function() {
          document.body.removeChild(modal);
        };
        content.appendChild(closeBtn);

        modal.appendChild(content);
        document.body.appendChild(modal);

        // Auto-select text
        setTimeout(function() {
          textarea.select();
          textarea.focus();
        }, 100);

        // Close on backdrop click
        modal.onclick = function(e) {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        };
      }

      /**
       * Show success/error/info message with auto-dismiss
       * @param {string} message - Message text to display
       * @param {string} type - Message type: 'success', 'error', or 'info'
       */
      function showMessage(message, type) {
        var errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.className = 'message ' + (type || 'info');
        errorDiv.classList.remove('hidden');

        // Auto-hide: 3 seconds for success/info, 5 seconds for error
        var duration = type === 'error' ? 5000 : 3000;
        setTimeout(function() {
          errorDiv.classList.add('hidden');
        }, duration);
      }

      // ============================================================================
      // MODE SELECTION MANAGEMENT
      // ============================================================================

      /**
       * Handle search mode change (duration vs contiguous)
       */
      function handleModeChange() {
        var selectedMode = document.querySelector('input[name="searchMode"]:checked').value;

        // Save mode to session storage
        sessionStorage.setItem('availability_searchMode', selectedMode);

        // Show/hide duration input based on mode
        updateDurationFieldVisibility();
      }

      /**
       * Update visibility and requirement of duration input based on selected mode
       */
      function updateDurationFieldVisibility() {
        var selectedMode = document.querySelector('input[name="searchMode"]:checked').value;
        var durationGroup = document.getElementById('minDuration').closest('.form-group');
        var durationInput = document.getElementById('minDuration');

        if (selectedMode === 'contiguous') {
          // Hide duration input in contiguous mode (not needed)
          durationGroup.style.display = 'none';
          durationInput.removeAttribute('required');
          durationInput.value = '15'; // Set to minimum for server-side granularity
        } else {
          // Show duration input in duration mode
          durationGroup.style.display = 'block';
          durationInput.setAttribute('required', 'required');
          // Restore previous value if cached, otherwise default to 30
          var cachedDuration = sessionStorage.getItem('availability_minDuration') || '30';
          durationInput.value = cachedDuration;
        }
      }

      // State
      let selectedCalendar = null;
      var allAvailableSlots = []; // Store all slots for clipboard operations
      var allCalendarEvents = []; // Store all calendar events for display

      // Initialize on load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeAvailabilityScreen);
      } else {
        initializeAvailabilityScreen();
      }

      function initializeAvailabilityScreen() {
        // Load selected calendar
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              selectedCalendar = response.calendar;
              document.getElementById('calendarName').textContent = response.calendar.name;
            } else {
              showError('No calendar selected. Please return to menu and select a calendar.');
            }
          })
          .withFailureHandler(function(error) {
            showError('Failed to load calendar: ' + error.message);
          })
          .getSelectedCalendar();

        // Try to restore previous search settings from sessionStorage
        var cachedStartDateTime = sessionStorage.getItem('availability_startDateTime');
        var cachedEndDateTime = sessionStorage.getItem('availability_endDateTime');
        var cachedMinDuration = sessionStorage.getItem('availability_minDuration');
        var cachedSearchMode = sessionStorage.getItem('availability_searchMode') || 'duration';

        console.log('Restoring from cache:', { cachedStartDateTime, cachedEndDateTime, cachedMinDuration, cachedSearchMode });

        if (cachedStartDateTime && cachedEndDateTime) {
          // Restore from cache
          console.log('Using cached values');
          document.getElementById('startDateTime').value = cachedStartDateTime;
          document.getElementById('endDateTime').value = cachedEndDateTime;
          if (cachedMinDuration) {
            document.getElementById('minDuration').value = cachedMinDuration;
          }
        } else {
          // Set default dates (next business day at 09:00 to 4 business days later at 17:30)
          console.log('Using default values');
          var nextBusinessDay = getNextBusinessDay(new Date());
          nextBusinessDay.setHours(9, 0, 0, 0);

          var fourBusinessDaysLater = addBusinessDays(nextBusinessDay, 4);
          fourBusinessDaysLater.setHours(17, 30, 0, 0);

          var startValue = formatDateTimeLocal(nextBusinessDay);
          var endValue = formatDateTimeLocal(fourBusinessDaysLater);

          document.getElementById('startDateTime').value = startValue;
          document.getElementById('endDateTime').value = endValue;

          // Save the initial default values to sessionStorage
          sessionStorage.setItem('availability_startDateTime', startValue);
          sessionStorage.setItem('availability_endDateTime', endValue);
          sessionStorage.setItem('availability_minDuration', '30');
          console.log('Saved initial defaults to sessionStorage');
        }

        // Restore search mode and update UI
        var modeRadios = document.querySelectorAll('input[name="searchMode"]');
        modeRadios.forEach(function(radio) {
          if (radio.value === cachedSearchMode) {
            radio.checked = true;
          }
        });
        updateDurationFieldVisibility();

        // Add event listeners to update day of week and save to sessionStorage
        document.getElementById('startDateTime').addEventListener('change', function() {
          updateStartDayOfWeek();
          saveSearchSettings();
        });
        document.getElementById('endDateTime').addEventListener('change', function() {
          updateEndDayOfWeek();
          saveSearchSettings();
        });
        document.getElementById('minDuration').addEventListener('change', saveSearchSettings);

        // Initial update of day of week
        updateStartDayOfWeek();
        updateEndDayOfWeek();
      }

      function saveSearchSettings() {
        var startDateTime = document.getElementById('startDateTime').value;
        var endDateTime = document.getElementById('endDateTime').value;
        var minDuration = document.getElementById('minDuration').value;
        var searchMode = document.querySelector('input[name="searchMode"]:checked').value;

        console.log('Saving to sessionStorage:', { startDateTime, endDateTime, minDuration, searchMode });

        if (startDateTime) {
          sessionStorage.setItem('availability_startDateTime', startDateTime);
        }
        if (endDateTime) {
          sessionStorage.setItem('availability_endDateTime', endDateTime);
        }
        if (minDuration) {
          sessionStorage.setItem('availability_minDuration', minDuration);
        }
        if (searchMode) {
          sessionStorage.setItem('availability_searchMode', searchMode);
        }
      }

      function formatDateTimeLocal(date) {
        var year = date.getFullYear();
        var month = String(date.getMonth() + 1).padStart(2, '0');
        var day = String(date.getDate()).padStart(2, '0');
        var hours = String(date.getHours()).padStart(2, '0');
        var minutes = String(date.getMinutes()).padStart(2, '0');
        return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
      }

      function getNextBusinessDay(date) {
        var result = new Date(date);
        result.setDate(result.getDate() + 1); // Start from tomorrow

        // If it's Saturday (6), add 2 days to get to Monday
        // If it's Sunday (0), add 1 day to get to Monday
        var dayOfWeek = result.getDay();
        if (dayOfWeek === 0) { // Sunday
          result.setDate(result.getDate() + 1);
        } else if (dayOfWeek === 6) { // Saturday
          result.setDate(result.getDate() + 2);
        }

        return result;
      }

      function addBusinessDays(startDate, numberOfDays) {
        var result = new Date(startDate);
        var addedDays = 0;

        while (addedDays < numberOfDays) {
          result.setDate(result.getDate() + 1);
          var dayOfWeek = result.getDay();

          // Only count weekdays (Monday-Friday)
          if (dayOfWeek !== 0 && dayOfWeek !== 6) {
            addedDays++;
          }
        }

        return result;
      }

      function updateStartDayOfWeek() {
        var input = document.getElementById('startDateTime');
        var span = document.getElementById('startDayOfWeek');
        if (input.value) {
          var date = new Date(input.value);
          var dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
          span.textContent = '[' + dayName + ']';
        } else {
          span.textContent = '';
        }
      }

      function updateEndDayOfWeek() {
        var input = document.getElementById('endDateTime');
        var span = document.getElementById('endDayOfWeek');
        if (input.value) {
          var date = new Date(input.value);
          var dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
          span.textContent = '[' + dayName + ']';
        } else {
          span.textContent = '';
        }
      }

      function handleFindAvailability(event) {
        event.preventDefault();

        var startDateTime = document.getElementById('startDateTime').value;
        var endDateTime = document.getElementById('endDateTime').value;
        var minDuration = parseInt(document.getElementById('minDuration').value);
        var searchMode = document.querySelector('input[name="searchMode"]:checked').value;

        // Save search settings to sessionStorage
        saveSearchSettings();

        // Client-side validation
        if (!startDateTime || !endDateTime) {
          showError('Please select both start and end date/time');
          return;
        }

        if (!minDuration || isNaN(minDuration)) {
          showError('Please enter a valid duration');
          return;
        }

        if (minDuration < 15 || minDuration > 120) {
          showError('Duration must be between 15 and 120 minutes');
          return;
        }

        var startDateTimeObj = new Date(startDateTime);
        var endDateTimeObj = new Date(endDateTime);

        if (startDateTimeObj >= endDateTimeObj) {
          showError('From date/time must be before To date/time');
          return;
        }

        // Calculate time difference
        var timeDiffMs = endDateTimeObj - startDateTimeObj;
        var daysDiff = timeDiffMs / (1000 * 60 * 60 * 24);

        if (daysDiff > 14) {
          showError('Date range must be 14 days or less');
          return;
        }

        // Hide previous results/errors
        hideAll();
        showLoading(true);

        // Call server with date-time range, minimum duration, and search mode
        google.script.run
          .withSuccessHandler(function(response) {
            console.log('Server response:', response);
            showLoading(false);
            if (response.success) {
              console.log('Displaying results for', response.slots.length, 'slots');
              displayResults(response, minDuration);
            } else {
              console.error('Server returned error:', response.error);
              showError(response.error);
            }
          })
          .withFailureHandler(function(error) {
            console.error('Server call failed:', error);
            showLoading(false);
            showError('Server error: ' + error.message);
          })
          .findAvailability(startDateTime, endDateTime, minDuration, searchMode);
      }

      function displayResults(response, minDuration) {
        console.log('displayResults called with', response.slots.length, 'slots');

        // Store slots globally for clipboard operations
        allAvailableSlots = response.slots;

        // Store calendar events globally for display
        allCalendarEvents = response.events || [];

        // Show empty state only if BOTH slots and events are empty
        if (response.slots.length === 0 && allCalendarEvents.length === 0) {
          console.log('No slots or events found, showing empty state');
          showEmptyState();
          return;
        }

        // Check for events error and show warning if present
        if (response.eventsError) {
          showMessage(response.eventsError, 'error');
        }

        // Show metadata
        var metadata = response.metadata;
        console.log('Metadata:', metadata);

        // Format search mode display with visual emphasis
        var modeText = '';
        if (metadata.searchMode === 'contiguous') {
          modeText = '<br>Mode: <span style="background-color: #f0f7ff; padding: 0.125rem 0.5rem; border-radius: 3px; font-weight: 600;">Contiguous availability blocks</span>';
        } else {
          modeText = '<br>Mode: <span style="background-color: #f0f7ff; padding: 0.125rem 0.5rem; border-radius: 3px; font-weight: 600;">Duration-based slots</span>';
        }

        var durationText = minDuration && minDuration > 15 && metadata.searchMode === 'duration' ? '<br>Minimum duration: ' + minDuration + ' minutes' : '';
        var metadataHtml = '<p><strong>Search Results</strong></p>' +
          '<p class="text-muted" style="font-size: 0.875rem;">' +
          'Date range: ' + formatDate(new Date(metadata.dateRange.start)) + ' - ' + formatDate(new Date(metadata.dateRange.end)) + '<br>' +
          'Working days: ' + metadata.workingDaysCount + '<br>' +
          'Available slots: ' + metadata.totalSlotsFound +
          modeText +
          durationText +
          '</p>';
        document.getElementById('resultsMetadata').innerHTML = metadataHtml;
        console.log('Metadata HTML updated');

        // Group slots by date
        var slotsByDate = groupSlotsByDate(response.slots);
        console.log('Grouped slots:', slotsByDate);

        // Group events by date
        var eventsByDate = groupEventsByDate(allCalendarEvents);
        console.log('Grouped events:', eventsByDate);

        // Get all unique dates (from both slots and events)
        var allDates = {};
        for (var dateStr in slotsByDate) {
          allDates[dateStr] = true;
        }
        for (var dateStr in eventsByDate) {
          allDates[dateStr] = true;
        }

        // Sort dates chronologically
        var sortedDates = Object.keys(allDates).sort();
        console.log('All dates to render:', sortedDates);

        // Render slots and events together for all dates
        var slotsHtml = '';
        sortedDates.forEach(function(dateStr) {
          var dateSlots = slotsByDate[dateStr] || [];
          var dateEvents = eventsByDate[dateStr] || [];
          console.log('Rendering date:', dateStr, 'with', dateSlots.length, 'slots and', dateEvents.length, 'events');

          slotsHtml += '<div class="card mb-2">';
          slotsHtml += '<h3 style="font-size: 1.125rem; margin-bottom: 0.5rem;">' + formatDate(new Date(dateStr)) + '</h3>';
          slotsHtml += '<div>';

          // Render Available section (existing slots)
          if (dateSlots.length > 0) {
            slotsHtml += '<div class="section-header">Available</div>';
            dateSlots.forEach(function(slot) {
              var slotId = getSlotId(slot);
              var isSelected = SelectionManager.isSelected(slotId);

              slotsHtml += '<div class="slot-item' + (isSelected ? ' selected' : '') + '">';
              slotsHtml += '<label class="slot-label">';
              slotsHtml += '<input type="checkbox" class="slot-checkbox" data-slot-id="' + slotId + '" ' +
                           'onchange="handleSlotToggle(this)" ' + (isSelected ? 'checked' : '') + '>';
              slotsHtml += '<span class="slot-time">' + slot.formattedStart + ' - ' + slot.formattedEnd + '</span>';
              slotsHtml += '<span class="slot-duration">(' + slot.formattedDuration + ')</span>';
              slotsHtml += '</label>';
              slotsHtml += '</div>';
            });
          }

          // Render Scheduled section (new events)
          slotsHtml += renderScheduledSection(dateEvents);

          slotsHtml += '</div>';
          slotsHtml += '</div>';
        });

        console.log('Slots HTML length:', slotsHtml.length);
        document.getElementById('resultsSlots').innerHTML = slotsHtml;
        document.getElementById('resultsSection').classList.remove('hidden');
        console.log('Results section shown');

        // Update selection controls after rendering
        updateSelectedCount();
        updateCopyButton();
      }

      function groupSlotsByDate(slots) {
        var grouped = {};
        slots.forEach(function(slot) {
          var dateStr = slot.date;
          if (!grouped[dateStr]) {
            grouped[dateStr] = [];
          }
          grouped[dateStr].push(slot);
        });
        return grouped;
      }

      /**
       * Group calendar events by date
       * @param {Array<Object>} events - Array of calendar event objects
       * @returns {Object} Events grouped by date string (YYYY-MM-DD)
       */
      function groupEventsByDate(events) {
        var grouped = {};
        events.forEach(function(event) {
          var dateStr = event.date;
          if (!grouped[dateStr]) {
            grouped[dateStr] = [];
          }
          grouped[dateStr].push(event);
        });
        return grouped;
      }

      /**
       * Render scheduled events section for a single date
       * @param {Array<Object>} events - Array of calendar events for this date
       * @returns {string} HTML string for the scheduled section
       */
      function renderScheduledSection(events) {
        if (!events || events.length === 0) {
          return ''; // Return empty string if no events
        }

        var html = '<div class="section-header">Scheduled</div>';

        events.forEach(function(event) {
          html += '<div class="event-item">';
          html += '<span class="event-time">' + event.formattedStart + ' - ' + event.formattedEnd + '</span>';
          html += '<span class="event-title">' + event.displayTitle + '</span>';
          html += '</div>';
        });

        return html;
      }

      function formatDate(date) {
        var options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }

      function navigateToMenu() {
        // Clear selection state when navigating away
        SelectionManager.clear();

        google.script.run
          .withSuccessHandler(function(html) {
            // Replace entire document with menu
            document.open();
            document.write(html);
            document.close();

            // Manually trigger initialization after document.write
            if (typeof window.initializeMenu === 'function') {
              window.initializeMenu();
            }
          })
          .withFailureHandler(function(error) {
            showError('Failed to load menu: ' + error.message);
          })
          .loadMenu();
      }

      function showLoading(show) {
        var indicator = document.getElementById('loadingIndicator');
        if (show) {
          indicator.classList.remove('hidden');
        } else {
          indicator.classList.add('hidden');
        }
      }

      function showError(message) {
        showMessage(message, 'error');
      }

      function showEmptyState() {
        document.getElementById('emptyState').classList.remove('hidden');
      }

      function hideAll() {
        document.getElementById('resultsSection').classList.add('hidden');
        document.getElementById('emptyState').classList.add('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
      }
    </script>
  </body>
</html>
